

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}



model User {
    // Scalar
    id              String      @id
    name            String
    email           String      @unique
    image           String
    cart            Json        @default("{}")

    // Relations
    ratings         Rating[]
    Address         Address[]
    store           Store?
    buyerOrders     Order[]     @relation("BuyerRelation")
}

model Category {
    // Scalar
    id              String      @id @default(cuid())
    name            String
    slug            String      @unique
    description     String?
    parentId        String?
    createdAt       DateTime    @default(now())
    updatedAt       DateTime    @updatedAt

    // Relations
    parent          Category?    @relation("CategoryTree", fields: [parentId], references: [id])
    children        Category[]   @relation("CategoryTree")
    products        Product[]

    @@index([parentId])
}

model Product {
    //  Scalar
    id              String      @id @default(cuid())
    name            String
    slug            String      @unique
    description     String
    mrp             Float
    price           Float
    images          String[]
    inStock         Boolean     @default(true)
    categoryId      String
    storeId         String
    createdAt       DateTime    @default(now())
    updatedAt       DateTime    @updatedAt

    // Relations
    category        Category    @relation(fields: [categoryId], references: [id])
    store           Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
    orderItems      OrderItem[]
    rating          Rating[]
    tags            ProductTag[]

    @@unique([storeId, slug])
    @@index([storeId])
    @@index([categoryId])
    @@index([createdAt])
}


model Tag {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique
  description       String?
  isSystem          Boolean     @default(false)
  isActive          Boolean     @default(true)

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  products    ProductTag[]

  @@index([isActive])
}

model ProductTag {
  productId         String
  tagId             String 
  assignedBy        String?
  createdAt         DateTime    @default(now())

  // Relations
  product Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag                   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([tagId])
  @@index([productId])
}



enum OrderStatus {
    ORDER_PLACED
    PROCESSING
    SHIPPED
    DELIVERED
}

enum PaymentMethod {
    COD
    STRIPE
}

enum BusinessType {
  INDIVIDUAL
  COMPANY
  PARTNERSHIP
}

enum ConsentSubjectType {
  STORE
  USER
}

enum ConsentType {
  TERMS
  MARKETING
  PRIVACY
}

enum StoreStatus {
  PENDING
  APPROVED
  REJECTED
}

model OrderItem {
    //  Scalar
    quantity        Int
    price           Float
    productId       String
    orderId         String

    // Relations
    product         Product         @relation(fields: [productId], references: [id])
    order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

    @@id([orderId, productId])
}

model Order {
    // Scalar
    id              String          @id @default(cuid())
    total           Float
    status          OrderStatus     @default(ORDER_PLACED)
    isPaid          Boolean         @default(false)
    paymentMethod   PaymentMethod   
    isCouponUsed    Boolean         @default(false)
    coupon          Json            @default("{}")
    userId          String
    storeId         String
    addressId       String
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt


    // Relations
    orderItems      OrderItem[]
    user            User            @relation("BuyerRelation", fields: [userId], references: [id])
    store           Store           @relation(fields: [storeId], references: [id])
    address         Address         @relation(fields: [addressId], references: [id])

    @@index([userId, createdAt])
    @@index([storeId, createdAt])
    @@index([status, createdAt])
}

model Rating {
    // Scalar
    id              String          @id @default(cuid())
    rating          Int
    review          String
    userId          String
    productId       String
    orderId         String
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt

    //Relations
    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@unique([userId, productId, orderId])
}

model Address {
    // Scalar
    id              String          @id @default(cuid())
    name            String
    email           String
    street          String
    city            String
    state           String
    zip             String
    country         String
    phone           String
    userId          String
    createdAt       DateTime        @default(now())
    isArchived      Boolean         @default(false)    

    // Relations
    Order           Order[]
    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([isArchived])
}

model Coupon {
    code            String          @id
    description     String
    discount        Float
    forNewUser      Boolean
    forMember       Boolean         @default(false)
    isPublic        Boolean
    expiresAt       DateTime
    createdAt       DateTime        @default(now())
}

model Store {
    // Scalar
    id              String          @id @default(cuid())
    name            String
    description     String
    username        String          @unique
    email           String
    contact         String
    address         Json
    businessType    BusinessType
    registrationNo  String?
    taxId           String?
    status          StoreStatus     @default(PENDING)
    reason          Json?
    isActive        Boolean         @default(false)
    slug            String          @unique
    subdomain       String?
    customDomain    String?
    logo            String
    coverImage      String?
    favicon         String?
    themeColor      String?
    metaTitle       String?
    metaDescription String?
    userId          String          @unique
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt

    // Relations
    products        Product[]
    orders          Order[]
    settings        StoreSettings?
    user            User            @relation(fields: [userId], references: [id])

    @@index([slug])
    @@index([isActive, status])
    @@index([createdAt])
}

model StoreSettings {
    // Scalar
    id              String          @id @default(cuid())
    currency        String          @default("USD")
    timezone        String          @default("UTC")
    language        String          @default("en")
    taxRate         Float           @default(0.0)
    emailNotifications Json          @default("{}")
    storeId         String          @unique

    // Relations
    store           Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model Consent {
  id           String              @id @default(cuid())
  subjectType  ConsentSubjectType
  subjectId    String
  type         ConsentType
  version      String
  accepted     Boolean
  acceptedAt   DateTime            @default(now())
  createdAt    DateTime            @default(now())

  @@index([subjectType, subjectId])
  @@index([type])
}
